<html lang="en">
 <head> 
  <meta charset="utf-8" /> 
  <meta http-equiv="pragma" content="no-cache" />
  <meta name="uyan_auth" content="45307a8898" /> 
  <meta http-equiv="Cache-Control" content="no-cache,no-store, must-revalidate" /> 
  <meta http-equiv="Expires" content="0" /> 
  <title>光光的小站</title> 
  <meta name="author" content="" />
  <link href="/bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet" /> 
    <link href="/bootstrap/css/twitter.css" type="text/css" rel="stylesheet" /> 
    <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">
<link rel="stylesheet" id="font-bitter-css" href="http://fonts.googleapis.com/css?family=Bitter&amp;ver=1" type="text/css" media="screen">
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <link href="/css/main.css" rel="stylesheet" type="text/css">
 </head> 
 <body > 
  <div class="navbar navbar-fixed-top"> 
   <div class="navbar-inner"> 
    <div class="container"> 
     <a class="brand" href="/">首页</a> 
     <ul class="nav"> 
      <li> <a href="/about.html">关于我</a> </li> 
      <li> <a href="/archive.html">我的博文</a> </li> 
     </ul> 
     <ul class="nav navbar-nav navbar-right">
        <li>
          <form class="form-search navsearch" action="/search.html" method="get">
  <input type="text" class="input-medium search-query" autocomplete="off" name="title"data-provide="typeahead" id="title_search">
  <button class="btn" type="submit">Search</button>
</form>
        </li>
      </ul>
    </div> 
   </div>

  </div>
    <div class="container"> 
     <div class="content"> 
    <div class="page-header"> 
     <h1 style='color:#2196ff'>Canvas API</h1> 
    </div> 

<h2>概述</h2>

<p>Canvas用于在网页展示图像，并且可以定制内容，基本上它是一个可以用JavaScript操作的位图（bitmap）。</p>

<p>Canvas API用于网页实时生成图像，JavaScript通过API来操作图像内容。这样做的优点是：减少HTTP请求数，减少下载的数据，加快网页载入时间，可以对图像进行实时处理。</p>

<p>使用前，首先需要新建一个canvas网页元素。</p>

<div class="highlight"><pre><code class="html"><span class="nt">&lt;canvas</span> <span class="na">id=</span><span class="s">&quot;myCanvas&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span> <span class="na">height=</span><span class="s">&quot;200&quot;</span><span class="nt">&gt;</span>
    您的浏览器不支持canvas！
<span class="nt">&lt;/canvas&gt;</span>
</code></pre>
</div>

<p>如果浏览器不支持这个API，则就会显示canvas标签中间的文字——“您的浏览器不支持canvas！”。</p>

<p>然后，使用JavaScript获取canvas的DOM对象。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;myCanvas&#39;</span><span class="p">);</span>
</code></pre>
</div>

<p>接着，检查浏览器是否支持Canvas API，方法是看有没有部署getContext方法。</p>

<div class="highlight"><pre><code class="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some code here</span>
<span class="p">}</span>
</code></pre>
</div>

<p>使用getContext(&#39;2d&#39;)方法，初始化平面图像的上下文环境。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
</code></pre>
</div>

<p>现在就在canvas中间生成平面图像了。</p>

<h2>绘图方法</h2>

<p>（1）填充颜色</p>

<p>设置填充颜色。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#000000&quot;</span><span class="p">;</span> <span class="c1">// 设置填充色为黑色</span>
</code></pre>
</div>

<p>（2）绘制矩形</p>

<p>绘制实心矩形。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span> 
</code></pre>
</div>

<p>绘制空心矩形。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeRect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span> 
</code></pre>
</div>

<p>清除某个矩形区域的内容。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>  
</code></pre>
</div>

<p>（3）绘制路径</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="c1">// 开始路径绘制</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="c1">// 设置路径起点</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="c1">// 绘制一条到200, 20的直线</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="c1">// 设置线宽</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s2">&quot;#CC0000&quot;</span><span class="p">;</span> <span class="c1">// 设置线的颜色</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span> <span class="c1">// 进行线的着色，这时整条线才变得可见</span>
</code></pre>
</div>

<p>moveto和lineto方法可以多次使用。最后，还可以使用closePath方法，自动绘制一条当前点到起点的直线，形成一个封闭图形，省却使用以此lineto方法。</p>

<p>（4）绘制圆形和扇形</p>

<p>绘制扇形的方法。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">startAngle</span><span class="p">,</span> <span class="nx">endAngle</span><span class="p">,</span> <span class="nx">anticlockwise</span><span class="p">);</span>
</code></pre>
</div>

<p>arc方法的x和y参数是圆心坐标，radius是半径，startAngle和endAngle则是扇形的起始角度和终止角度（以弧度表示），anticlockwise表示做图时应该逆时针画（true）还是顺时针画（false）。</p>

<p>绘制实心的圆形。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#000000&quot;</span><span class="p">;</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
</code></pre>
</div>

<p>绘制空心圆形。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s2">&quot;#000&quot;</span><span class="p">;</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
</code></pre>
</div>

<p>（5）绘制文本</p>

<p>fillText方法用于添加文本，strokeText方法用于添加空心字。使用之前，需设定字体、对齐方向、颜色等属性。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s2">&quot;Bold 20px Arial&quot;</span><span class="p">;</span> <span class="c1">// 设置字体</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">textAlign</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span> <span class="c1">// 设置对齐方式</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#008600&quot;</span><span class="p">;</span> <span class="c1">// 设置填充颜色</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="s2">&quot;Hello!&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span> <span class="c1">// 设置字体内容，以及在画布上的位置</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeText</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">Hello</span><span class="o">!</span><span class="err">&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span> <span class="c1">// 绘制空心字</span>
</code></pre>
</div>

<p>fillText方法不支持文本断行，即所有文本出现在一行内。所以，如果你要生成多行文本，只有调用多次fillText方法。</p>

<h3>渐变</h3>

<p>设置渐变色。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">myGradient</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">createLinearGradient</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">);</span> 

<span class="nx">myGradient</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;#BABABA&quot;</span><span class="p">);</span> 

<span class="nx">myGradient</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;#636363&quot;</span><span class="p">);</span>
</code></pre>
</div>

<p>createLinearGradient方法的参数是(x1, y1, x2, y2)，其中x1和y1是起点坐标，x2和y2是终点坐标。通过不同的坐标值，可以生成从上至下、从左到右的渐变等等。</p>

<p>使用方法如下：</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">myGradient</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</code></pre>
</div>

<h3>阴影</h3>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 设置水平位移</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 设置垂直位移</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowBlur</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// 设置模糊度</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowColor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0.5)&quot;</span><span class="p">;</span> <span class="c1">// 设置阴影颜色</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#CC0000&quot;</span><span class="p">;</span> 
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</code></pre>
</div>

<h2>图像处理方法</h2>

<h3>插入图像</h3>

<p>canvas允许将图像文件插入画布，做法是读取图片后，使用drawImage方法在画布内进行重绘。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>

<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;image.png&quot;</span><span class="p">;</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 设置对应的图像对象，以及它在画布上的位置</span>
</code></pre>
</div>

<p>由于图像的载入需要时间，drawImage方法只能在图像完全载入后才能调用，因此上面的代码需要改写。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span> 

<span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 

    <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">!=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
        <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
        <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span> 

<span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;image.png&quot;</span><span class="p">;</span>
</code></pre>
</div>

<p>drawImage()方法接受三个参数，第一个参数是图像文件的DOM元素（即img标签），第二个和第三个参数是图像左上角在Canvas元素中的坐标，上例中的（0, 0）就表示将图像左上角放置在Canvas元素的左上角。</p>

<h3>读取Canvas的内容</h3>

<p>getImageData方法可以用来读取Canvas的内容，返回一个对象，包含了每个像素的信息。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">imageData</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</code></pre>
</div>

<p>imageData对象有一个data属性，它的值是一个一维数组。该数组的值，依次是每个像素的红、绿、蓝、alpha通道值，因此该数组的长度等于 图像的像素宽度 x 图像的像素高度 x 4，每个值的范围是0–255。这个数组不仅可读，而且可写，因此通过操作这个数组的值，就可以达到操作图像的目的。修改这个数组以后，使用putImageData方法将数组内容重新回Canvas。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">imageData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre>
</div>

<h3>像素处理</h3>

<p>假定filter是一个处理像素的函数，那么整个对Canvas的处理流程，可以用下面的代码表示。</p>

<div class="highlight"><pre><code class="javascript"><span class="k">if</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">imageData</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="nx">filter</span><span class="p">(</span><span class="nx">imageData</span><span class="p">);</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">imageData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>
</code></pre>
</div>

<p>以下是几种常见的处理方法。</p>

<p>（1）灰度效果</p>

<p>灰度图（grayscale）就是取红、绿、蓝三个像素值的算术平均值，这实际上将图像转成了黑白形式。假定d[i]是像素数组中一个象素的红色值，则d[i+1]为绿色值，d[i+2]为蓝色值，d[i+3]就是alpha通道值。转成灰度的算法，就是将红、绿、蓝三个值相加后除以3，再将结果写回数组。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">grayscale</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pixels</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">pixels</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
      <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="nx">g</span><span class="o">+</span><span class="nx">b</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">pixels</span><span class="p">;</span>

<span class="p">};</span>
</code></pre>
</div>

<p>（2）复古效果</p>

<p>复古效果（sepia）则是将红、绿、蓝三个像素，分别取这三个值的某种加权平均值，使得图像有一种古旧的效果。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">sepia</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pixels</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">pixels</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
      <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>     <span class="o">=</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span> <span class="mf">0.393</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span> <span class="mf">0.769</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span> <span class="mf">0.189</span><span class="p">);</span> <span class="c1">// red</span>
      <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span> <span class="mf">0.349</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span> <span class="mf">0.686</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span> <span class="mf">0.168</span><span class="p">);</span> <span class="c1">// green</span>
      <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span> <span class="mf">0.272</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span> <span class="mf">0.534</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span> <span class="mf">0.131</span><span class="p">);</span> <span class="c1">// blue</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">pixels</span><span class="p">;</span>

<span class="p">};</span>
</code></pre>
</div>

<p>（3）红色蒙版效果</p>

<p>红色蒙版指的是，让图像呈现一种偏红的效果。算法是将红色通道设为红、绿、蓝三个值的平均值，而将绿色通道和蓝色通道都设为0。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">red</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pixels</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">pixels</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
      <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span><span class="o">+</span><span class="nx">g</span><span class="o">+</span><span class="nx">b</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>        <span class="c1">// 红色通道取平均值</span>
      <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 绿色通道和蓝色通道都设为0</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">pixels</span><span class="p">;</span>

<span class="p">};</span>
</code></pre>
</div>

<p>（4）亮度效果</p>

<p>亮度效果（brightness）是指让图像变得更亮或更暗。算法将红色通道、绿色通道、蓝色通道，同时加上一个正值或负值。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">brightness</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pixels</span><span class="p">,</span> <span class="nx">delta</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">pixels</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">delta</span><span class="p">;</span>     <span class="c1">// red</span>
          <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">delta</span><span class="p">;</span> <span class="c1">// green</span>
          <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">delta</span><span class="p">;</span> <span class="c1">// blue   </span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">pixels</span><span class="p">;</span>

<span class="p">};</span>
</code></pre>
</div>

<p>（5）反转效果</p>

<p>反转效果（invert）是值图片呈现一种色彩颠倒的效果。算法为红、绿、蓝通道都取各自的相反值（255-原值）。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pixels</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">pixels</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">d</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">pixels</span><span class="p">;</span>

<span class="p">};</span>
</code></pre>
</div>

<h3>将Canvas转化为图像文件</h3>

<p>对图像数据做出修改以后，可以使用toDataURL方法，将Canvas数据重新转化成一般的图像文件形式。</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">convertCanvasToImage</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
  <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">image</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>上面的代码将Canvas数据，转化成PNG data URI。</p>

<h2>保存和恢复上下文</h2>

<p>save方法用于保存上下文环境，restore方法用于恢复到上一次保存的上下文环境。</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowBlur</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">shadowColor</span> <span class="o">=</span> <span class="s2">&quot;rgba(0,0,0,0.5)&quot;</span><span class="p">;</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#CC0000&quot;</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>

<span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span> 

<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&quot;#000000&quot;</span><span class="p">;</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span> 
</code></pre>
</div>

<p>上面的代码一共绘制了两个矩形，前一个有阴影，后一个没有。</p>

<h2>参考链接</h2>

<ul>
<li>David Walsh, <a href="http://davidwalsh.name/convert-canvas-image">JavaScript Canvas Image Conversion</a></li>
<li>Matt West, <a href="http://blog.teamtreehouse.com/getting-started-with-the-canvas-api">Getting Started With The Canvas API</a></li>
<li>John Robinson, <a href="http://www.storminthecastle.com/2013/04/06/how-you-can-do-cool-image-effects-using-html5-canvas/">How You Can Do Cool Image Effects Using HTML5 Canvas</a></li>
</ul>

<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1889589"></script>
<!-- UY END -->
 </div>
   
 

   <footer> 
    <p>&copy; Powered By <a href="http://jekyllrb.com/" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll</a> and <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a> </p> 
   </footer>
   <script type="text/javascript" src="/js/typehead.js"></script>
    <script type="text/javascript">
      var titleString='["Basic commands of Tcl","网络入门","我们为何渐渐放弃了自己的梦想","Canvas API","Unix Shell","Welcome to Jekyll!"]',titleItems = JSON.parse(titleString);     
    </script> 
    <script>
$(document).ready(function($) {
   // Workaround for bug in mouse item selection
   $.fn.typeahead.Constructor.prototype.blur = function() {
      var that = this;
      setTimeout(function () { that.hide() }, 250);
   };
 
   $('#title_search').typeahead({
      source: function(query, process) {
         return titleItems;
      }
   });
})
</script>
  </div> 
 </body>
</html>